{% extends "dashboard/base.html" %}
{% block title %}Blocklist - ProxyGuard{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-white mb-2">Blocklist Management</h2>
        <p class="text-gray-500">Manage blocked domains, IPs, ports, and custom rules</p>
    </div>
    <div class="flex gap-2">
        <button onclick="location.reload()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-dark-900 rounded-xl border border-gray-800 p-4">
        <div class="text-gray-500 text-sm">Blocked Domains</div>
        <div class="text-2xl font-bold text-red-400">{{ domain_count }}</div>
    </div>
    <div class="bg-dark-900 rounded-xl border border-gray-800 p-4">
        <div class="text-gray-500 text-sm">Blocked IPs</div>
        <div class="text-2xl font-bold text-orange-400">{{ ip_count }}</div>
    </div>
    <div class="bg-dark-900 rounded-xl border border-gray-800 p-4">
        <div class="text-gray-500 text-sm">Blocked Ports</div>
        <div class="text-2xl font-bold text-yellow-400">{{ port_count }}</div>
    </div>
    <div class="bg-dark-900 rounded-xl border border-gray-800 p-4">
        <div class="text-gray-500 text-sm">Custom Rules</div>
        <div class="text-2xl font-bold text-purple-400">{{ rule_count }}</div>
    </div>
    <div class="bg-dark-900 rounded-xl border border-gray-800 p-4">
        <div class="text-gray-500 text-sm">Total Hits</div>
        <div class="text-2xl font-bold text-blue-400">{{ total_hits }}</div>
    </div>
</div>

<!-- Tabs -->
<div class="mb-6">
    <div class="flex border-b border-gray-800">
        <button onclick="showTab('domains')" id="tab-domains" class="px-6 py-3 text-sm font-medium border-b-2 border-red-500 text-red-400">
            <i class="fas fa-globe mr-2"></i>Domains
        </button>
        <button onclick="showTab('ips')" id="tab-ips" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-300">
            <i class="fas fa-network-wired mr-2"></i>IPs
        </button>
        <button onclick="showTab('ports')" id="tab-ports" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-300">
            <i class="fas fa-plug mr-2"></i>Ports
        </button>
        <button onclick="showTab('rules')" id="tab-rules" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-300">
            <i class="fas fa-cogs mr-2"></i>Custom Rules
        </button>
    </div>
</div>

<!-- Domains Tab -->
<div id="panel-domains" class="tab-panel">
    <div class="bg-dark-900 rounded-xl border border-gray-800 overflow-hidden">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center flex-wrap gap-2">
            <h3 class="font-semibold text-white">Blocked Domains</h3>
            <div class="flex gap-2">
                <input type="text" id="domain-search" placeholder="Search domains..."
                    class="bg-dark-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:border-blue-500" 
                    onkeyup="filterDomains()">
                <button onclick="showAddDomainModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                    <i class="fas fa-plus mr-2"></i>Add Domain
                </button>
            </div>
        </div>
        <div class="overflow-auto max-h-[500px]">
            <table class="w-full text-sm">
                <thead class="bg-dark-950 sticky top-0">
                    <tr class="text-gray-500 text-xs uppercase">
                        <th class="px-4 py-3 text-left">Domain</th>
                        <th class="px-4 py-3 text-left">Category</th>
                        <th class="px-4 py-3 text-left">Reason</th>
                        <th class="px-4 py-3 text-center">Wildcard</th>
                        <th class="px-4 py-3 text-center">Hits</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800" id="domains-table">
                    {% for domain in blocked_domains %}
                    <tr class="hover:bg-dark-800/50 domain-row" 
                        data-domain="{{ domain.domain|lower }}"
                        data-id="{{ domain.id }}"
                        data-category="{{ domain.category }}"
                        data-reason="{{ domain.reason|default:'' }}"
                        data-active="{{ domain.is_active|yesno:'true,false' }}">
                        <td class="px-4 py-3 font-mono text-gray-300">
                            {{ domain.domain }}
                            {% if domain.is_wildcard %}
                            <span class="ml-2 text-xs text-yellow-400">(wildcard)</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs
                                {% if domain.category == 'malware' %}bg-red-900/50 text-red-400
                                {% elif domain.category == 'ads' %}bg-yellow-900/50 text-yellow-400
                                {% elif domain.category == 'adult' %}bg-pink-900/50 text-pink-400
                                {% elif domain.category == 'social' %}bg-blue-900/50 text-blue-400
                                {% elif domain.category == 'phishing' %}bg-orange-900/50 text-orange-400
                                {% elif domain.category == 'streaming' %}bg-purple-900/50 text-purple-400
                                {% else %}bg-gray-700 text-gray-300{% endif %}">
                                {{ domain.category }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-gray-500 text-xs max-w-xs truncate">{{ domain.reason|default:"-" }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if domain.is_wildcard %}
                            <i class="fas fa-check text-green-400"></i>
                            {% else %}
                            <i class="fas fa-minus text-gray-600"></i>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center text-red-400 font-bold">{{ domain.hit_count }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if domain.is_active %}
                            <span class="text-green-400 text-xs"><i class="fas fa-circle"></i> Active</span>
                            {% else %}
                            <span class="text-gray-500 text-xs"><i class="fas fa-circle"></i> Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="editDomain({{ domain.id }}, '{{ domain.domain }}', '{{ domain.category }}', '{{ domain.reason|default:""|escapejs }}', {{ domain.is_active|yesno:'true,false' }})" 
                                    class="p-1.5 text-blue-400 hover:bg-blue-900/30 rounded" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleDomain({{ domain.id }})" class="p-1.5 text-yellow-400 hover:bg-yellow-900/30 rounded" title="Toggle">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deleteDomain({{ domain.id }}, '{{ domain.domain }}')" class="p-1.5 text-red-400 hover:bg-red-900/30 rounded" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No blocked domains</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- IPs Tab -->
<div id="panel-ips" class="tab-panel hidden">
    <div class="bg-dark-900 rounded-xl border border-gray-800 overflow-hidden">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h3 class="font-semibold text-white">Blocked IPs</h3>
            <button onclick="showAddIPModal()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm">
                <i class="fas fa-plus mr-2"></i>Add IP
            </button>
        </div>
        <div class="overflow-auto max-h-[500px]">
            <table class="w-full text-sm">
                <thead class="bg-dark-950 sticky top-0">
                    <tr class="text-gray-500 text-xs uppercase">
                        <th class="px-4 py-3 text-left">IP Address</th>
                        <th class="px-4 py-3 text-left">Type</th>
                        <th class="px-4 py-3 text-left">Reason</th>
                        <th class="px-4 py-3 text-center">Hits</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800" id="ips-table">
                    {% for ip in blocked_ips %}
                    <tr class="hover:bg-dark-800/50">
                        <td class="px-4 py-3 font-mono text-gray-300">
                            {{ ip.ip_address }}{% if ip.cidr_prefix %}/{{ ip.cidr_prefix }}{% endif %}
                            {% if ip.is_range %}<span class="ml-2 text-xs text-yellow-400">(CIDR)</span>{% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs
                                {% if ip.ip_type == 'source' %}bg-blue-900/50 text-blue-400
                                {% elif ip.ip_type == 'destination' %}bg-purple-900/50 text-purple-400
                                {% else %}bg-green-900/50 text-green-400{% endif %}">
                                {{ ip.ip_type }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-gray-500 text-xs">{{ ip.reason|default:"-" }}</td>
                        <td class="px-4 py-3 text-center text-red-400 font-bold">{{ ip.hit_count }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if ip.is_active %}
                            <span class="text-green-400 text-xs"><i class="fas fa-circle"></i> Active</span>
                            {% else %}
                            <span class="text-gray-500 text-xs"><i class="fas fa-circle"></i> Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="editIP({{ ip.id }}, '{{ ip.ip_address }}{% if ip.cidr_prefix %}/{{ ip.cidr_prefix }}{% endif %}', '{{ ip.ip_type }}', '{{ ip.reason|default:""|escapejs }}')" 
                                    class="p-1.5 text-blue-400 hover:bg-blue-900/30 rounded" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleIP({{ ip.id }})" class="p-1.5 text-yellow-400 hover:bg-yellow-900/30 rounded" title="Toggle">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deleteIP({{ ip.id }})" class="p-1.5 text-red-400 hover:bg-red-900/30 rounded" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No blocked IPs</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ports Tab -->
<div id="panel-ports" class="tab-panel hidden">
    <div class="bg-dark-900 rounded-xl border border-gray-800 overflow-hidden">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h3 class="font-semibold text-white">Blocked Ports</h3>
            <button onclick="showAddPortModal()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm">
                <i class="fas fa-plus mr-2"></i>Add Port
            </button>
        </div>
        <div class="overflow-auto max-h-[500px]">
            <table class="w-full text-sm">
                <thead class="bg-dark-950 sticky top-0">
                    <tr class="text-gray-500 text-xs uppercase">
                        <th class="px-4 py-3 text-left">Port</th>
                        <th class="px-4 py-3 text-left">Type</th>
                        <th class="px-4 py-3 text-left">Protocol</th>
                        <th class="px-4 py-3 text-left">Reason</th>
                        <th class="px-4 py-3 text-center">Hits</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800" id="ports-table">
                    {% for port in blocked_ports %}
                    <tr class="hover:bg-dark-800/50">
                        <td class="px-4 py-3 font-mono text-gray-300">
                            {{ port.port }}{% if port.port_end %}-{{ port.port_end }}{% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300">{{ port.port_type }}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-400">{{ port.protocol|upper }}</td>
                        <td class="px-4 py-3 text-gray-500 text-xs">{{ port.reason|default:"-" }}</td>
                        <td class="px-4 py-3 text-center text-red-400 font-bold">{{ port.hit_count }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if port.is_active %}
                            <span class="text-green-400 text-xs"><i class="fas fa-circle"></i> Active</span>
                            {% else %}
                            <span class="text-gray-500 text-xs"><i class="fas fa-circle"></i> Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="editPort({{ port.id }}, {{ port.port }}, {{ port.port_end|default:'null' }}, '{{ port.port_type }}', '{{ port.protocol }}', '{{ port.reason|default:""|escapejs }}')" 
                                    class="p-1.5 text-blue-400 hover:bg-blue-900/30 rounded" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="togglePort({{ port.id }})" class="p-1.5 text-yellow-400 hover:bg-yellow-900/30 rounded" title="Toggle">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deletePort({{ port.id }})" class="p-1.5 text-red-400 hover:bg-red-900/30 rounded" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No blocked ports</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Rules Tab -->
<div id="panel-rules" class="tab-panel hidden">
    <div class="bg-dark-900 rounded-xl border border-gray-800 overflow-hidden">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h3 class="font-semibold text-white">Custom Rules</h3>
            <button onclick="showAddRuleModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                <i class="fas fa-plus mr-2"></i>Add Rule
            </button>
        </div>
        <div class="overflow-auto max-h-[500px]">
            <table class="w-full text-sm">
                <thead class="bg-dark-950 sticky top-0">
                    <tr class="text-gray-500 text-xs uppercase">
                        <th class="px-4 py-3 text-left">Name</th>
                        <th class="px-4 py-3 text-left">Conditions</th>
                        <th class="px-4 py-3 text-center">Action</th>
                        <th class="px-4 py-3 text-center">Priority</th>
                        <th class="px-4 py-3 text-center">Hits</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800" id="rules-table">
                    {% for rule in block_rules %}
                    <tr class="hover:bg-dark-800/50">
                        <td class="px-4 py-3 text-gray-300 font-medium">{{ rule.name }}</td>
                        <td class="px-4 py-3 text-gray-500 text-xs">
                            <div class="flex flex-wrap gap-1">
                                {% if rule.domain_pattern %}<span class="bg-dark-800 px-2 py-0.5 rounded">Domain: {{ rule.domain_pattern }}</span>{% endif %}
                                {% if rule.source_ip %}<span class="bg-dark-800 px-2 py-0.5 rounded">Src: {{ rule.source_ip }}{% if rule.source_ip_cidr %}/{{ rule.source_ip_cidr }}{% endif %}</span>{% endif %}
                                {% if rule.dest_ip %}<span class="bg-dark-800 px-2 py-0.5 rounded">Dst: {{ rule.dest_ip }}{% if rule.dest_ip_cidr %}/{{ rule.dest_ip_cidr }}{% endif %}</span>{% endif %}
                                {% if rule.source_port_start %}<span class="bg-dark-800 px-2 py-0.5 rounded">SrcPort: {{ rule.source_port_start }}{% if rule.source_port_end %}-{{ rule.source_port_end }}{% endif %}</span>{% endif %}
                                {% if rule.dest_port_start %}<span class="bg-dark-800 px-2 py-0.5 rounded">DstPort: {{ rule.dest_port_start }}{% if rule.dest_port_end %}-{{ rule.dest_port_end }}{% endif %}</span>{% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded text-xs
                                {% if rule.action == 'block' %}bg-red-900/50 text-red-400
                                {% elif rule.action == 'allow' %}bg-green-900/50 text-green-400
                                {% else %}bg-blue-900/50 text-blue-400{% endif %}">
                                {{ rule.action }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-blue-400">{{ rule.priority }}</td>
                        <td class="px-4 py-3 text-center text-red-400 font-bold">{{ rule.hit_count }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if rule.is_active %}
                            <span class="text-green-400 text-xs"><i class="fas fa-circle"></i> Active</span>
                            {% else %}
                            <span class="text-gray-500 text-xs"><i class="fas fa-circle"></i> Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="editRule({{ rule.id }})" class="p-1.5 text-blue-400 hover:bg-blue-900/30 rounded" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleRule({{ rule.id }})" class="p-1.5 text-yellow-400 hover:bg-yellow-900/30 rounded" title="Toggle">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deleteRule({{ rule.id }}, '{{ rule.name }}')" class="p-1.5 text-red-400 hover:bg-red-900/30 rounded" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No custom rules</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Domain Modal (Add/Edit) -->
<div id="domain-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-dark-900 rounded-xl border border-gray-800 w-full max-w-lg mx-4 p-6">
        <h3 class="text-lg font-semibold text-white mb-4" id="domain-modal-title">
            <i class="fas fa-globe text-red-400 mr-2"></i>Add Blocked Domain
        </h3>
        <form id="domain-form">
            <input type="hidden" id="domain-edit-id" value="">
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Domain Pattern *</label>
                <input type="text" id="domain-input" placeholder="example.com or *.example.com" required
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 font-mono focus:outline-none focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">
                    Wildcards: <code class="bg-dark-800 px-1">*.example.com</code>, <code class="bg-dark-800 px-1">*ads*</code>, <code class="bg-dark-800 px-1">.example.com</code>
                </p>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Category</label>
                <select id="domain-category" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    <option value="manual">Manual</option>
                    <option value="ads">Advertising</option>
                    <option value="malware">Malware</option>
                    <option value="phishing">Phishing</option>
                    <option value="adult">Adult Content</option>
                    <option value="social">Social Media</option>
                    <option value="gambling">Gambling</option>
                    <option value="streaming">Streaming</option>
                    <option value="gaming">Gaming</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Reason</label>
                <input type="text" id="domain-reason" placeholder="Optional reason"
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-4" id="domain-active-wrapper" style="display: none;">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="domain-active" checked class="w-4 h-4 rounded">
                    <span class="text-sm text-gray-400">Active</span>
                </label>
            </div>
            <div class="flex gap-2">
                <button type="submit" id="domain-submit-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    <i class="fas fa-ban mr-2"></i>Block Domain
                </button>
                <button type="button" onclick="hideModal('domain-modal')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- IP Modal (Add/Edit) -->
<div id="ip-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-dark-900 rounded-xl border border-gray-800 w-full max-w-lg mx-4 p-6">
        <h3 class="text-lg font-semibold text-white mb-4" id="ip-modal-title">
            <i class="fas fa-network-wired text-orange-400 mr-2"></i>Add Blocked IP
        </h3>
        <form id="ip-form">
            <input type="hidden" id="ip-edit-id" value="">
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">IP Address *</label>
                <input type="text" id="ip-input" placeholder="192.168.1.1 or 192.168.1.0/24" required
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 font-mono focus:outline-none focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">Supports CIDR notation for IP ranges (e.g., 10.0.0.0/8)</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Block Type</label>
                <select id="ip-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    <option value="source">Source IP (block clients)</option>
                    <option value="destination">Destination IP (block targets)</option>
                    <option value="both">Both</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Reason</label>
                <input type="text" id="ip-reason" placeholder="Optional reason"
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex gap-2">
                <button type="submit" id="ip-submit-btn" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    <i class="fas fa-ban mr-2"></i>Block IP
                </button>
                <button type="button" onclick="hideModal('ip-modal')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Port Modal (Add/Edit) -->
<div id="port-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-dark-900 rounded-xl border border-gray-800 w-full max-w-lg mx-4 p-6">
        <h3 class="text-lg font-semibold text-white mb-4" id="port-modal-title">
            <i class="fas fa-plug text-yellow-400 mr-2"></i>Add Blocked Port
        </h3>
        <form id="port-form">
            <input type="hidden" id="port-edit-id" value="">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Port Start *</label>
                    <input type="number" id="port-start" placeholder="80" min="1" max="65535" required
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Port End (for range)</label>
                    <input type="number" id="port-end" placeholder="Optional" min="1" max="65535"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Block Type</label>
                    <select id="port-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                        <option value="destination">Destination Port</option>
                        <option value="source">Source Port</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Protocol</label>
                    <select id="port-protocol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="both">Both</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Reason</label>
                <input type="text" id="port-reason" placeholder="Optional reason"
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex gap-2">
                <button type="submit" id="port-submit-btn" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                    <i class="fas fa-ban mr-2"></i>Block Port
                </button>
                <button type="button" onclick="hideModal('port-modal')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Rule Modal (Add/Edit) -->
<div id="rule-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center overflow-auto py-8">
    <div class="bg-dark-900 rounded-xl border border-gray-800 w-full max-w-2xl mx-4 p-6">
        <h3 class="text-lg font-semibold text-white mb-4" id="rule-modal-title">
            <i class="fas fa-cogs text-purple-400 mr-2"></i>Add Custom Rule
        </h3>
        <form id="rule-form">
            <input type="hidden" id="rule-edit-id" value="">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Rule Name *</label>
                    <input type="text" id="rule-name" placeholder="Block corporate network" required
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Priority</label>
                    <input type="number" id="rule-priority" value="100" min="1" max="1000"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Lower = Higher priority</p>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Domain Pattern (optional)</label>
                <input type="text" id="rule-domain" placeholder="*.example.com"
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 font-mono focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Source IP (CIDR)</label>
                    <input type="text" id="rule-source-ip" placeholder="192.168.1.0/24"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 font-mono focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Destination IP (CIDR)</label>
                    <input type="text" id="rule-dest-ip" placeholder="10.0.0.0/8"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 font-mono focus:outline-none focus:border-blue-500">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Source Port Range</label>
                    <div class="flex gap-2">
                        <input type="number" id="rule-src-port-start" placeholder="Start" min="1" max="65535"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                        <input type="number" id="rule-src-port-end" placeholder="End" min="1" max="65535"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Destination Port Range</label>
                    <div class="flex gap-2">
                        <input type="number" id="rule-dst-port-start" placeholder="Start" min="1" max="65535"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                        <input type="number" id="rule-dst-port-end" placeholder="End" min="1" max="65535"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Action</label>
                <select id="rule-action" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                    <option value="block">Block</option>
                    <option value="allow">Allow (whitelist)</option>
                    <option value="log">Log Only</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Reason</label>
                <textarea id="rule-reason" placeholder="Optional description" rows="2"
                    class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"></textarea>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" id="rule-submit-btn" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-plus mr-2"></i>Create Rule
                </button>
                <button type="button" onclick="hideModal('rule-modal')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';

// Tab switching
function showTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('[id^="tab-"]').forEach(t => {
        t.classList.remove('border-red-500', 'border-orange-500', 'border-yellow-500', 'border-purple-500');
        t.classList.remove('text-red-400', 'text-orange-400', 'text-yellow-400', 'text-purple-400');
        t.classList.add('border-transparent', 'text-gray-500');
    });
    
    document.getElementById(`panel-${tab}`).classList.remove('hidden');
    const tabBtn = document.getElementById(`tab-${tab}`);
    tabBtn.classList.remove('border-transparent', 'text-gray-500');
    
    const colors = { domains: 'red', ips: 'orange', ports: 'yellow', rules: 'purple' };
    tabBtn.classList.add(`border-${colors[tab]}-500`, `text-${colors[tab]}-400`);
}

// Modal functions
function showModal(id) {
    document.getElementById(id).classList.remove('hidden');
    document.getElementById(id).classList.add('flex');
}

function hideModal(id) {
    document.getElementById(id).classList.add('hidden');
    document.getElementById(id).classList.remove('flex');
}

// Filter domains
function filterDomains() {
    const search = document.getElementById('domain-search').value.toLowerCase();
    document.querySelectorAll('.domain-row').forEach(row => {
        const domain = row.dataset.domain || '';
        row.style.display = domain.includes(search) ? '' : 'none';
    });
}

// API helper
async function apiCall(url, method = 'GET', data = null) {
    const options = {
        method,
        headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': csrfToken 
        }
    };
    if (data) options.body = JSON.stringify(data);
    return await fetch(url, options);
}

// =============== DOMAIN FUNCTIONS ===============
function showAddDomainModal() {
    document.getElementById('domain-modal-title').innerHTML = '<i class="fas fa-globe text-red-400 mr-2"></i>Add Blocked Domain';
    document.getElementById('domain-submit-btn').innerHTML = '<i class="fas fa-ban mr-2"></i>Block Domain';
    document.getElementById('domain-edit-id').value = '';
    document.getElementById('domain-input').value = '';
    document.getElementById('domain-input').disabled = false;
    document.getElementById('domain-category').value = 'manual';
    document.getElementById('domain-reason').value = '';
    document.getElementById('domain-active-wrapper').style.display = 'none';
    showModal('domain-modal');
}

function editDomain(id, domain, category, reason, isActive) {
    document.getElementById('domain-modal-title').innerHTML = '<i class="fas fa-edit text-blue-400 mr-2"></i>Edit Domain';
    document.getElementById('domain-submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    document.getElementById('domain-edit-id').value = id;
    document.getElementById('domain-input').value = domain;
    document.getElementById('domain-input').disabled = true;
    document.getElementById('domain-category').value = category;
    document.getElementById('domain-reason').value = reason;
    document.getElementById('domain-active').checked = isActive;
    document.getElementById('domain-active-wrapper').style.display = 'block';
    showModal('domain-modal');
}

document.getElementById('domain-form').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('domain-edit-id').value;
    const data = {
        domain: document.getElementById('domain-input').value,
        category: document.getElementById('domain-category').value,
        reason: document.getElementById('domain-reason').value
    };
    if (id) {
        data.is_active = document.getElementById('domain-active').checked;
    }
    
    const url = id ? `/api/blocklist/domains/${id}/` : '/api/blocklist/domains/';
    const method = id ? 'PATCH' : 'POST';
    
    const res = await apiCall(url, method, data);
    if (res.ok) location.reload();
    else alert('Error saving domain');
};

async function toggleDomain(id) {
    await apiCall(`/api/blocklist/domains/${id}/toggle/`, 'POST');
    location.reload();
}

async function deleteDomain(id, domain) {
    if (confirm(`Delete "${domain}" from blocklist?`)) {
        await apiCall(`/api/blocklist/domains/${id}/`, 'DELETE');
        location.reload();
    }
}

// =============== IP FUNCTIONS ===============
function showAddIPModal() {
    document.getElementById('ip-modal-title').innerHTML = '<i class="fas fa-network-wired text-orange-400 mr-2"></i>Add Blocked IP';
    document.getElementById('ip-submit-btn').innerHTML = '<i class="fas fa-ban mr-2"></i>Block IP';
    document.getElementById('ip-edit-id').value = '';
    document.getElementById('ip-input').value = '';
    document.getElementById('ip-input').disabled = false;
    document.getElementById('ip-type').value = 'source';
    document.getElementById('ip-reason').value = '';
    showModal('ip-modal');
}

function editIP(id, ip, ipType, reason) {
    document.getElementById('ip-modal-title').innerHTML = '<i class="fas fa-edit text-blue-400 mr-2"></i>Edit IP';
    document.getElementById('ip-submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    document.getElementById('ip-edit-id').value = id;
    document.getElementById('ip-input').value = ip;
    document.getElementById('ip-input').disabled = true;
    document.getElementById('ip-type').value = ipType;
    document.getElementById('ip-reason').value = reason;
    showModal('ip-modal');
}

document.getElementById('ip-form').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('ip-edit-id').value;
    const data = {
        ip_address: document.getElementById('ip-input').value,
        ip_type: document.getElementById('ip-type').value,
        reason: document.getElementById('ip-reason').value
    };
    
    const url = id ? `/api/blocklist/ips/${id}/` : '/api/blocklist/ips/';
    const method = id ? 'PATCH' : 'POST';
    
    const res = await apiCall(url, method, data);
    if (res.ok) location.reload();
    else alert('Error saving IP');
};

async function toggleIP(id) {
    await apiCall(`/api/blocklist/ips/${id}/toggle/`, 'POST');
    location.reload();
}

async function deleteIP(id) {
    if (confirm('Delete this IP from blocklist?')) {
        await apiCall(`/api/blocklist/ips/${id}/`, 'DELETE');
        location.reload();
    }
}

// =============== PORT FUNCTIONS ===============
function showAddPortModal() {
    document.getElementById('port-modal-title').innerHTML = '<i class="fas fa-plug text-yellow-400 mr-2"></i>Add Blocked Port';
    document.getElementById('port-submit-btn').innerHTML = '<i class="fas fa-ban mr-2"></i>Block Port';
    document.getElementById('port-edit-id').value = '';
    document.getElementById('port-start').value = '';
    document.getElementById('port-end').value = '';
    document.getElementById('port-type').value = 'destination';
    document.getElementById('port-protocol').value = 'tcp';
    document.getElementById('port-reason').value = '';
    showModal('port-modal');
}

function editPort(id, port, portEnd, portType, protocol, reason) {
    document.getElementById('port-modal-title').innerHTML = '<i class="fas fa-edit text-blue-400 mr-2"></i>Edit Port';
    document.getElementById('port-submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    document.getElementById('port-edit-id').value = id;
    document.getElementById('port-start').value = port;
    document.getElementById('port-end').value = portEnd || '';
    document.getElementById('port-type').value = portType;
    document.getElementById('port-protocol').value = protocol;
    document.getElementById('port-reason').value = reason;
    showModal('port-modal');
}

document.getElementById('port-form').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('port-edit-id').value;
    const portEnd = document.getElementById('port-end').value;
    const data = {
        port: parseInt(document.getElementById('port-start').value),
        port_end: portEnd ? parseInt(portEnd) : null,
        port_type: document.getElementById('port-type').value,
        protocol: document.getElementById('port-protocol').value,
        reason: document.getElementById('port-reason').value
    };
    
    const url = id ? `/api/blocklist/ports/${id}/` : '/api/blocklist/ports/';
    const method = id ? 'PATCH' : 'POST';
    
    const res = await apiCall(url, method, data);
    if (res.ok) location.reload();
    else alert('Error saving port');
};

async function togglePort(id) {
    await apiCall(`/api/blocklist/ports/${id}/toggle/`, 'POST');
    location.reload();
}

async function deletePort(id) {
    if (confirm('Delete this port from blocklist?')) {
        await apiCall(`/api/blocklist/ports/${id}/`, 'DELETE');
        location.reload();
    }
}

// =============== RULE FUNCTIONS ===============
function showAddRuleModal() {
    document.getElementById('rule-modal-title').innerHTML = '<i class="fas fa-cogs text-purple-400 mr-2"></i>Add Custom Rule';
    document.getElementById('rule-submit-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Create Rule';
    document.getElementById('rule-edit-id').value = '';
    document.getElementById('rule-name').value = '';
    document.getElementById('rule-priority').value = '100';
    document.getElementById('rule-domain').value = '';
    document.getElementById('rule-source-ip').value = '';
    document.getElementById('rule-dest-ip').value = '';
    document.getElementById('rule-src-port-start').value = '';
    document.getElementById('rule-src-port-end').value = '';
    document.getElementById('rule-dst-port-start').value = '';
    document.getElementById('rule-dst-port-end').value = '';
    document.getElementById('rule-action').value = 'block';
    document.getElementById('rule-reason').value = '';
    showModal('rule-modal');
}

async function editRule(id) {
    // Fetch rule data
    const res = await apiCall(`/api/blocklist/rules/${id}/`);
    if (!res.ok) {
        alert('Error loading rule');
        return;
    }
    const rule = await res.json();
    
    document.getElementById('rule-modal-title').innerHTML = '<i class="fas fa-edit text-blue-400 mr-2"></i>Edit Rule';
    document.getElementById('rule-submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    document.getElementById('rule-edit-id').value = id;
    document.getElementById('rule-name').value = rule.name || '';
    document.getElementById('rule-priority').value = rule.priority || 100;
    document.getElementById('rule-domain').value = rule.domain_pattern || '';
    document.getElementById('rule-source-ip').value = rule.source_ip ? (rule.source_ip + (rule.source_ip_cidr ? '/' + rule.source_ip_cidr : '')) : '';
    document.getElementById('rule-dest-ip').value = rule.dest_ip ? (rule.dest_ip + (rule.dest_ip_cidr ? '/' + rule.dest_ip_cidr : '')) : '';
    document.getElementById('rule-src-port-start').value = rule.source_port_start || '';
    document.getElementById('rule-src-port-end').value = rule.source_port_end || '';
    document.getElementById('rule-dst-port-start').value = rule.dest_port_start || '';
    document.getElementById('rule-dst-port-end').value = rule.dest_port_end || '';
    document.getElementById('rule-action').value = rule.action || 'block';
    document.getElementById('rule-reason').value = rule.reason || '';
    showModal('rule-modal');
}

document.getElementById('rule-form').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('rule-edit-id').value;
    
    // Parse CIDR
    const srcIp = document.getElementById('rule-source-ip').value;
    const dstIp = document.getElementById('rule-dest-ip').value;
    let srcIpAddr = null, srcCidr = null, dstIpAddr = null, dstCidr = null;
    
    if (srcIp) {
        const parts = srcIp.split('/');
        srcIpAddr = parts[0];
        srcCidr = parts[1] ? parseInt(parts[1]) : null;
    }
    if (dstIp) {
        const parts = dstIp.split('/');
        dstIpAddr = parts[0];
        dstCidr = parts[1] ? parseInt(parts[1]) : null;
    }
    
    const data = {
        name: document.getElementById('rule-name').value,
        priority: parseInt(document.getElementById('rule-priority').value) || 100,
        domain_pattern: document.getElementById('rule-domain').value || null,
        source_ip: srcIpAddr,
        source_ip_cidr: srcCidr,
        dest_ip: dstIpAddr,
        dest_ip_cidr: dstCidr,
        source_port_start: document.getElementById('rule-src-port-start').value ? parseInt(document.getElementById('rule-src-port-start').value) : null,
        source_port_end: document.getElementById('rule-src-port-end').value ? parseInt(document.getElementById('rule-src-port-end').value) : null,
        dest_port_start: document.getElementById('rule-dst-port-start').value ? parseInt(document.getElementById('rule-dst-port-start').value) : null,
        dest_port_end: document.getElementById('rule-dst-port-end').value ? parseInt(document.getElementById('rule-dst-port-end').value) : null,
        action: document.getElementById('rule-action').value,
        reason: document.getElementById('rule-reason').value
    };
    
    const url = id ? `/api/blocklist/rules/${id}/` : '/api/blocklist/rules/';
    const method = id ? 'PATCH' : 'POST';
    
    const res = await apiCall(url, method, data);
    if (res.ok) location.reload();
    else alert('Error saving rule');
};

async function toggleRule(id) {
    await apiCall(`/api/blocklist/rules/${id}/toggle/`, 'POST');
    location.reload();
}

async function deleteRule(id, name) {
    if (confirm(`Delete rule "${name}"?`)) {
        await apiCall(`/api/blocklist/rules/${id}/`, 'DELETE');
        location.reload();
    }
}

// Close modals on escape key and backdrop click
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll('[id$="-modal"]').forEach(m => hideModal(m.id));
    }
});

document.querySelectorAll('[id$="-modal"]').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) hideModal(modal.id);
    });
});
</script>
{% endblock %}
