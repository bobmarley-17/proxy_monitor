{% extends "dashboard/base.html" %}
{% block title %}Blocklist - ProxyMonitor{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-white dark:text-white text-gray-900 mb-2">Blocklist Management</h2>
        <p class="text-gray-500">Manage blocked domains and rules</p>
    </div>
    <div class="flex gap-2">
        <button onclick="reloadBlocklist()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition" title="Restart proxy to apply changes">
            <i class="fas fa-sync-alt mr-2"></i>Reload
        </button>
        <button onclick="showAddModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
            <i class="fas fa-plus mr-2"></i>Add Domain
        </button>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 p-4">
        <div class="text-gray-500 text-sm">Total Blocked Domains</div>
        <div class="text-2xl font-bold text-white dark:text-white text-gray-900">{{ blocked_domains|length }}</div>
    </div>
    <div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 p-4">
        <div class="text-gray-500 text-sm">Active Rules</div>
        <div class="text-2xl font-bold text-green-400">{{ blocked_domains_count }}</div>
    </div>
    <div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 p-4">
        <div class="text-gray-500 text-sm">Total Hits</div>
        <div class="text-2xl font-bold text-red-400">{{ total_hits }}</div>
    </div>
    <div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 p-4">
        <div class="text-gray-500 text-sm">Categories</div>
        <div class="text-2xl font-bold text-blue-400">{{ categories|length }}</div>
    </div>
</div>

<!-- Category Summary -->
{% if categories %}
<div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 p-4 mb-6">
    <h3 class="font-semibold text-white dark:text-white text-gray-900 mb-3">Categories Overview</h3>
    <div class="flex flex-wrap gap-2">
        {% for cat in categories %}
        <span class="px-3 py-1.5 bg-dark-800 dark:bg-dark-800 bg-gray-100 rounded-lg text-sm cursor-pointer hover:bg-dark-700 transition" onclick="filterByCategory('{{ cat.category }}')">
            <span class="text-gray-300 dark:text-gray-300 text-gray-700 font-medium">{{ cat.category }}</span>
            <span class="ml-2 text-gray-500">{{ cat.count }} domains</span>
            <span class="ml-2 text-red-400 font-semibold">{{ cat.total_hits|default:0 }} hits</span>
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Blocklist Table -->
<div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 overflow-hidden">
    <div class="p-4 border-b border-gray-800 dark:border-gray-800 border-gray-200 flex flex-wrap gap-4 justify-between items-center">
        <h3 class="font-semibold text-white dark:text-white text-gray-900">Blocked Domains</h3>
        <div class="flex gap-2">
            <select id="category-filter" onchange="filterBlocklist()" class="bg-dark-800 dark:bg-dark-800 bg-gray-100 border border-gray-700 dark:border-gray-700 border-gray-300 rounded-lg px-3 py-1.5 text-sm">
                <option value="">All Categories</option>
                <option value="manual">Manual</option>
                <option value="ads">Advertising</option>
                <option value="malware">Malware</option>
                <option value="phishing">Phishing</option>
                <option value="adult">Adult Content</option>
                <option value="social">Social Media</option>
                <option value="gambling">Gambling</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="blocklist-search" placeholder="Search domains..." 
                class="bg-dark-800 dark:bg-dark-800 bg-gray-100 border border-gray-700 dark:border-gray-700 border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-blue-500 w-64"
                onkeyup="filterBlocklist()">
        </div>
    </div>
    <div class="overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
            <thead class="bg-dark-950 dark:bg-dark-950 bg-gray-50 sticky top-0">
                <tr class="text-gray-500 text-xs uppercase">
                    <th class="px-4 py-3 text-left">Domain</th>
                    <th class="px-4 py-3 text-left">Category</th>
                    <th class="px-4 py-3 text-left">Reason</th>
                    <th class="px-4 py-3 text-center">Hits</th>
                    <th class="px-4 py-3 text-center">Status</th>
                    <th class="px-4 py-3 text-left">Added</th>
                    <th class="px-4 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-800 dark:divide-gray-800 divide-gray-200" id="blocklist-table">
                {% for domain in blocked_domains %}
                <tr class="hover:bg-dark-800/50 dark:hover:bg-dark-800/50 hover:bg-gray-50 blocklist-row" 
                    id="domain-{{ domain.id }}" 
                    data-domain="{{ domain.domain|lower }}"
                    data-category="{{ domain.category }}"
                    data-id="{{ domain.id }}"
                    data-reason="{{ domain.reason|default:'' }}"
                    data-active="{{ domain.is_active|yesno:'true,false' }}">
                    <td class="px-4 py-3 font-mono text-gray-300 dark:text-gray-300 text-gray-700">{{ domain.domain }}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs 
                            {% if domain.category == 'malware' %}bg-red-900/50 text-red-400
                            {% elif domain.category == 'ads' %}bg-yellow-900/50 text-yellow-400
                            {% elif domain.category == 'adult' %}bg-pink-900/50 text-pink-400
                            {% elif domain.category == 'social' %}bg-blue-900/50 text-blue-400
                            {% elif domain.category == 'phishing' %}bg-orange-900/50 text-orange-400
                            {% elif domain.category == 'gambling' %}bg-purple-900/50 text-purple-400
                            {% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ domain.category }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-500 text-xs max-w-xs truncate" title="{{ domain.reason }}">
                        {{ domain.reason|default:"-"|truncatechars:30 }}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="{% if domain.hit_count > 0 %}text-red-400 font-bold{% else %}text-gray-500{% endif %}">
                            {{ domain.hit_count }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if domain.is_active %}
                        <span class="inline-flex items-center gap-1 text-green-400 text-xs">
                            <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                            Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 text-gray-500 text-xs">
                            <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                            Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-gray-500 text-xs whitespace-nowrap">{{ domain.created_at|date:"M d, Y" }}</td>
                    <td class="px-4 py-3 text-right whitespace-nowrap">
                        <button onclick="editDomain({{ domain.id }})" class="p-1.5 text-blue-400 hover:text-blue-300 hover:bg-blue-900/30 rounded transition" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleDomain({{ domain.id }})" class="p-1.5 text-yellow-400 hover:text-yellow-300 hover:bg-yellow-900/30 rounded transition" title="Toggle Active">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button onclick="resetHits({{ domain.id }})" class="p-1.5 text-gray-400 hover:text-gray-300 hover:bg-gray-700 rounded transition" title="Reset Hits">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button onclick="deleteDomain({{ domain.id }}, '{{ domain.domain }}')" class="p-1.5 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded transition" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr id="empty-row">
                    <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                        <i class="fas fa-ban text-4xl mb-3 opacity-30"></i>
                        <p>No blocked domains yet</p>
                        <p class="text-sm mt-1">Click "Add Domain" to block your first domain</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-dark-900 dark:bg-dark-900 bg-white rounded-xl border border-gray-800 dark:border-gray-800 border-gray-200 w-full max-w-md mx-4 p-6 shadow-2xl">
        <h3 class="text-lg font-semibold text-white dark:text-white text-gray-900 mb-4" id="modal-title">
            <i class="fas fa-ban text-red-400 mr-2"></i>Add Blocked Domain
        </h3>
        <form id="edit-form">
            <input type="hidden" id="edit-id" value="">
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Domain *</label>
                <input type="text" id="edit-domain" placeholder="example.com" required
                    class="w-full bg-dark-800 dark:bg-dark-800 bg-gray-100 border border-gray-700 dark:border-gray-700 border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 font-mono">
                <p class="text-xs text-gray-500 mt-1">Enter domain without http:// (e.g., youtube.com, *.facebook.com)</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Category</label>
                <select id="edit-category" class="w-full bg-dark-800 dark:bg-dark-800 bg-gray-100 border border-gray-700 dark:border-gray-700 border-gray-300 rounded-lg px-4 py-2">
                    <option value="manual">Manual</option>
                    <option value="ads">Advertising</option>
                    <option value="malware">Malware</option>
                    <option value="phishing">Phishing</option>
                    <option value="adult">Adult Content</option>
                    <option value="social">Social Media</option>
                    <option value="gambling">Gambling</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Reason (optional)</label>
                <textarea id="edit-reason" placeholder="Why is this domain blocked?" rows="2"
                    class="w-full bg-dark-800 dark:bg-dark-800 bg-gray-100 border border-gray-700 dark:border-gray-700 border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"></textarea>
            </div>
            
            <div class="mb-6" id="status-field" style="display: none;">
                <label class="flex items-center gap-3 cursor-pointer p-3 bg-dark-800 dark:bg-dark-800 bg-gray-100 rounded-lg">
                    <input type="checkbox" id="edit-active" checked 
                        class="w-5 h-5 rounded border-gray-600 text-blue-600 focus:ring-blue-500 focus:ring-offset-0">
                    <div>
                        <span class="text-sm text-gray-300 dark:text-gray-300 text-gray-700">Active</span>
                        <p class="text-xs text-gray-500">When active, this domain will be blocked</p>
                    </div>
                </label>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium" id="submit-btn">
                    <i class="fas fa-ban mr-2"></i>Block Domain
                </button>
                <button type="button" onclick="hideEditModal()" class="px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Filter by category click
    function filterByCategory(category) {
        document.getElementById('category-filter').value = category;
        filterBlocklist();
    }

    // Filter table
    function filterBlocklist() {
        const search = document.getElementById('blocklist-search').value.toLowerCase();
        const category = document.getElementById('category-filter').value.toLowerCase();
        const rows = document.querySelectorAll('.blocklist-row');
        
        rows.forEach(row => {
            const domain = row.dataset.domain;
            const cat = row.dataset.category.toLowerCase();
            
            const matchSearch = !search || domain.includes(search);
            const matchCategory = !category || cat === category;
            
            row.style.display = (matchSearch && matchCategory) ? '' : 'none';
        });
    }

    // Show Add Modal
    function showAddModal() {
        document.getElementById('modal-title').innerHTML = '<i class="fas fa-ban text-red-400 mr-2"></i>Add Blocked Domain';
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-ban mr-2"></i>Block Domain';
        document.getElementById('edit-id').value = '';
        document.getElementById('edit-domain').value = '';
        document.getElementById('edit-domain').removeAttribute('disabled');
        document.getElementById('edit-domain').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('edit-category').value = 'manual';
        document.getElementById('edit-reason').value = '';
        document.getElementById('edit-active').checked = true;
        document.getElementById('status-field').style.display = 'none';
        
        document.getElementById('edit-modal').classList.remove('hidden');
        document.getElementById('edit-modal').classList.add('flex');
        setTimeout(() => document.getElementById('edit-domain').focus(), 100);
    }

    // Edit Domain
    function editDomain(id) {
        const row = document.getElementById(`domain-${id}`);
        if (!row) return;
        
        const domain = row.querySelector('td:first-child').textContent.trim();
        const category = row.dataset.category;
        const reason = row.dataset.reason || '';
        const isActive = row.dataset.active === 'true';
        
        document.getElementById('modal-title').innerHTML = '<i class="fas fa-edit text-blue-400 mr-2"></i>Edit Domain Rule';
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-domain').value = domain;
        document.getElementById('edit-domain').setAttribute('disabled', 'disabled');
        document.getElementById('edit-domain').classList.add('opacity-50', 'cursor-not-allowed');
        document.getElementById('edit-category').value = category;
        document.getElementById('edit-reason').value = reason;
        document.getElementById('edit-active').checked = isActive;
        document.getElementById('status-field').style.display = 'block';
        
        document.getElementById('edit-modal').classList.remove('hidden');
        document.getElementById('edit-modal').classList.add('flex');
    }

    // Hide Modal
    function hideEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
        document.getElementById('edit-modal').classList.remove('flex');
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideEditModal();
    });

    // Close modal on backdrop click
    document.getElementById('edit-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('edit-modal')) hideEditModal();
    });

    // Submit Form
    document.getElementById('edit-form').onsubmit = async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('edit-id').value;
        const domain = document.getElementById('edit-domain').value.trim().toLowerCase();
        const category = document.getElementById('edit-category').value;
        const reason = document.getElementById('edit-reason').value.trim();
        const is_active = document.getElementById('edit-active').checked;
        
        if (!domain) {
            alert('Please enter a domain');
            return;
        }
        
        const url = id ? `/api/blocklist/domains/${id}/` : '/api/blocklist/domains/';
        const method = id ? 'PATCH' : 'POST';
        
        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        submitBtn.disabled = true;
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ domain, category, reason, is_active })
            });
            
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                let errorMsg = 'Error saving domain';
                if (data.domain) errorMsg = 'Domain: ' + data.domain.join(', ');
                else if (data.detail) errorMsg = data.detail;
                else if (data.non_field_errors) errorMsg = data.non_field_errors.join(', ');
                alert(errorMsg);
            }
        } catch (err) {
            alert('Network error. Please try again.');
            console.error(err);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    };

    // Toggle Domain
    async function toggleDomain(id) {
        try {
            const res = await fetch(`/api/blocklist/domains/${id}/toggle/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('Error toggling domain status');
            }
        } catch (err) {
            alert('Network error');
        }
    }

    // Reset Hits
    async function resetHits(id) {
        if (!confirm('Reset hit counter to 0?')) return;
        
        try {
            const res = await fetch(`/api/blocklist/domains/${id}/reset_hits/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.ok) {
                location.reload();
            }
        } catch (err) {
            alert('Error resetting hits');
        }
    }

    // Delete Domain
    async function deleteDomain(id, domain) {
        if (!confirm(`Delete "${domain}" from blocklist?\n\nThis action cannot be undone.`)) return;
        
        try {
            const res = await fetch(`/api/blocklist/domains/${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.ok) {
                const row = document.getElementById(`domain-${id}`);
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            } else {
                alert('Error deleting domain');
            }
        } catch (err) {
            alert('Network error');
        }
    }

    // Reload blocklist info
    function reloadBlocklist() {
        alert('To apply blocklist changes, restart the proxy server:\n\npython manage.py runproxy --port 8088');
    }
</script>
{% endblock %}
